<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/falcon.jpg?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/falcon.jpg?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Genuifx">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Genuifx">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Genuifx">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Genuifx</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Genuifx</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">世界和平</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
</li>

      

      
    </ul>
  

  
    

  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/12/from-promise-polyfill-to-event-loop-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="iveswen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Genuifx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/12/from-promise-polyfill-to-event-loop-2/" itemprop="url">从Promise到Event Loop（二）</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-12T15:59:09+08:00">2018-04-12</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/12/from-promise-polyfill-to-event-loop-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/04/12/from-promise-polyfill-to-event-loop-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在<a href="../from-promise-polyfill-to-eventloop">上一章</a>我们提出了一个promise和setTimeout回调执行顺序的疑问，并且一起研究了promise-polyfill的源码实现。然而，最初的问题还是没有得到解答，同时引出了更多的关于异步时序的思考，为了真正解决这个问题，我们必须深入理解一些js实现底层的东西。</p>
<h2 id="热身"><a href="#热身" class="headerlink" title="热身"></a>热身</h2><p>我们从下面这张经典图解开始了解，（引用自<a href="http://vimeo.com/96425312" title="Robert" target="_blank" rel="external">Robert</a>）<br><img src="/images/eventloop/model.png" alt="js模型图" title="js模型图"></p>
<p>这是一张js实现的模型图，请注意我的措辞“js实现”；实际上ecmascript并没有规定任何Event Loop的实现内容（划重点），如果去搜v8的源码，你会发现上图右边的web api实现都找不到，不管是XMLHttpRequest还是setTimeout的实现，我们都找不到出处。</p>
<p>原因很简单，web api 或者说 BOM，DOM这些都不是ecma的语言规范。</p>
<p>图中的内容老生常谈了，几乎每个js教程关于Event Loop都会挂这个，但还是稍微介绍一下：</p>
<h3 id="1-heap（堆）"><a href="#1-heap（堆）" class="headerlink" title="1. heap（堆）"></a>1. heap（堆）</h3><p>用于分配对象，对象名实际上一个指向一堆无结构的内存区域（同C语言的结构体？），需要注意的是，当我们形成闭包的时候，实际上作用域链也是保存到堆了。</p>
<h3 id="2-stack（栈）"><a href="#2-stack（栈）" class="headerlink" title="2. stack（栈）"></a>2. stack（栈）</h3><p>函数调用栈，当调用一个函数的时候，我们把函数入栈，当函数执行完毕，则从当前栈中弹出函数，并且继续执行下一个函数。javascript是单线程的语言主要是提现在这里，因为一个“thread”只有一个调用栈，所以一个时间片下永远都只能“专心”处理一件事，调用栈同样有调用深度的限制，一个无限循环自我调用的函数会把栈搞爆。<br><img src="/images/1_tqkykdU69DFrxi82JOWLbQ.png" alt=""></p>
<blockquote>
<p>引用自Medium</p>
</blockquote>
<h3 id="3-Event-Loop"><a href="#3-Event-Loop" class="headerlink" title="3. Event Loop"></a>3. Event Loop</h3><p>一个不断执行的循环，不断的从任务队列或者说消息队列读取需要执行的回调函数，当函数执行的时候，会执行入栈操作<br>所有例如<code>setTimeout(fn, 0)</code>这种操作并不能保证当前函数执行完了之后马上就运行，会有排队的延迟。zakas在<a href="https://www.nczonline.net/blog/2011/09/19/script-yielding-with-setimmediate/" target="_blank" rel="external">这篇文章</a>中还提到了timer的解析和耗电问题💯<br>Event Loop的实现一般看起来长这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (queue.waitForMessage()) &#123;</div><div class="line">  queue.processNextMessage();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ok，热身完毕，正餐开始。</p>
<h2 id="并发模型和事件循环"><a href="#并发模型和事件循环" class="headerlink" title="并发模型和事件循环"></a>并发模型和事件循环</h2><h3 id="以“Thread”为单位"><a href="#以“Thread”为单位" class="headerlink" title="以“Thread”为单位"></a>以“Thread”为单位</h3><p>我们常说javascript是单线程语言，首先需要明确一点的是上述的heap，stack和Event Loop都在一个“thread”下执行，对于chrome来说，每个window（页面窗口）就是一个“thread”，所以只有同一个“thread”下面的函数或者对象才能相互交流，而web worker和非同源的iframe都有自己独有的thread，相互之间并不能直接交流。</p>
<h3 id="Event-Loop-依赖js宿主环境实现"><a href="#Event-Loop-依赖js宿主环境实现" class="headerlink" title="Event Loop 依赖js宿主环境实现"></a>Event Loop 依赖js宿主环境实现</h3><p>ecma的spec并没有规定Event Loop应该怎么设计，这就决定了在不同的浏览器，不同的宿主环境（node，嵌入式）其Event Loop的实现不同，表现也不禁相同。</p>
<p>故而，promise与setTimeout的回调执行先后问题，实际上在不同浏览器不同版本运行结果都不相同。而由于没有规范规定实现，所有你不能说某个浏览器的是错误的，只能说哪种实现更为合理（当然现代浏览器的实现已经趋于一致。<br><img src="/images/eventloop/WX20180327-233228.png" alt=""></p>
<blockquote>
<p>同一份代码在不同浏览器的运行结果, 引用自<a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="external">jake</a></p>
</blockquote>
<h3 id="Event-Loop-是类似队列（queue-like）的结构"><a href="#Event-Loop-是类似队列（queue-like）的结构" class="headerlink" title="Event Loop 是类似队列（queue-like）的结构"></a>Event Loop 是类似队列（queue-like）的结构</h3><p>对node来说，Event Loop不是一个单纯的队列，而是由一个个Phase和Tick组成，每个Phase和Tick又有自己的任务队列。详见下文。<br>对chrome来说，Event Loop又分为Task（又叫MarcoTask）和MicroTask，各有自己任务队列，详见下文。<br>其他浏览器的资料由于闭源，网上没有找到相关资料，但是从表现上看估计实现差不多。如果有相关的信息欢迎分享链接。<br>故而，Event Loop从宏观的角度看的确是一个依次执行任务队列，但从微观实现而言并非简单的队列便万事大吉。</p>
<h3 id="Ecma-262的Jobs和Job-Queues"><a href="#Ecma-262的Jobs和Job-Queues" class="headerlink" title="Ecma-262的Jobs和Job Queues"></a>Ecma-262的Jobs和Job Queues</h3><p>上面我们说过，ecma并没有Event Loop的规范，但是如果读过ecma-262的spec的同学就会发现，在<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-jobs-and-job-queues" target="_blank" rel="external">8-4</a>有一个神奇的Jobs和Job Queues章节，被光速打脸了吗？不存在的</p>
<p>ecma的Jobs实际上为promise定义了标准实现。由于在es6，promise已经成为了语言标准之一，而ecma的引擎需要不依赖宿主实现promise，例如V8能够脱离浏览器单独运行，在没有浏览器webApi支持的情况下依然要支持promise实现。所以spec里面有这边规定并不奇怪。</p>
<p>所以Jobs Queues和Event Loop实际上是两个东西，那么当V8在chrome运行的时候，就会有一个问题，promise的回调应该在哪里运行？<br>如果在V8，Event Loop将无法知道捕获promise相关任务，二者并不能协调工作。<br>如果在Event Loop，必须覆盖了V8的相关实现。<br>于是Html5规范规定了宿主环境必须覆盖实现ecma的Job Queues，也是就是说在浏览器环境实际上promise的回调处理由Event Loop接手。<br><img src="/images/eventllop/v2-a0322f548ad45bf527ab36ae76b5b11b_r.jpg" alt=""></p>
<h2 id="Chrome的Task和MicroTask"><a href="#Chrome的Task和MicroTask" class="headerlink" title="Chrome的Task和MicroTask"></a>Chrome的Task和MicroTask</h2><p>Tasks一般被设计为浏览器能够介入其执行间歇，以便响应用户的操作，刷新UI，不管是页面的点击或者滚动事件，如果执行栈被阻塞的了，用户将会感觉到明显的卡顿。<br><img src="/images/eventloop/1_tqkykdU69DFrxi82JOWLbQ.png" alt=""></p>
<p>MicroTask一般则为了快速响应回调处理，如果当前调用栈没有其他执行函数的话，就会尽快的按照顺序调用对应回调，所以如果当前上下文已经没有待处理函数，或者两个Task之间的间歇都会执行MicroTask。值得注意的是，如果当前执行的MicroTask又动态添加了一个MicroTask的话，新的MicroTask会在这个周期内马上执行~</p>
<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><p>属于Task的的回调类型有： <code>setTimeout</code>，<code>XMLHttpRequest</code>， <code>IndexDB</code>，<code>事件IO</code>，<code>postMessage</code><br>属于MicroTask的回调类型有：<code>Promise</code>，<code>MutationObserver</code></p>
<h3 id="执行规则"><a href="#执行规则" class="headerlink" title="执行规则"></a>执行规则</h3><ol>
<li>Task回调按照顺序一个个执行，每个Task之间允许浏览器进行UI渲染</li>
<li>MicroTask回调按照顺序一个个执行，并且有以下执行时机</li>
</ol>
<p>关于chrome的Task和MicroTask主要从jake大大（google chrome技术支持）的<a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="external">文章</a>中了解到，如果有大佬对这方面有更深入的了解的话，评论，rtx求指教！！！</p>
<h2 id="node的Libuv"><a href="#node的Libuv" class="headerlink" title="node的Libuv"></a>node的Libuv</h2><p>同chrome，node也是使用V8引擎编译，解释ecma的语法。如果你认真看了前文，就知道node需要实现自己的EventLoop机制，以保证单线程的js能以异步方式处理并发事务。</p>
<p>node的Event Loop实现全部在<a href="http://nikhilm.github.io/uvbook/introduction.html#background" target="_blank" rel="external">Libuv</a></p>
<blockquote>
<p>The node.js project began in 2009 as a JavaScript environment decoupled from the browser. Using Google’s V8 and Marc Lehmann’s libev, node.js combined a model of I/O – evented – with a language that was well suited to the style of programming; due to the way it had been shaped by browsers. As node.js grew in popularity, it was important to make it work on Windows, but libev ran only on Unix. The Windows equivalent of kernel event notification mechanisms like kqueue or (e)poll is IOCP. libuv was an abstraction around libev or IOCP depending on the platform, providing users an API based on libev. In the node-v0.9.0 version of libuv libev was removed.</p>
</blockquote>
<p>一开始的node.js实现并不支持window环境，后来用户越来越多了，需要支持window环境，但是原来的libev又不支持，于是大佬们便自己整了一个libuv，实现了node自己的事件循环机制，抹平了底层差异，对Module提供统一的api。</p>
<p>当实例化一个node应用的时候，libuv会初始化一个线程池用于处理一些没有操作系统API支持的异步事件。也就是说libuv并非独立于js运行时，他和V8应该在一个线程下工作，异步IO处理也并非都在单独线程，libuv会优先使用系统提供API进行处理。</p>
<p><img src="/images/eventloop/nodejs-EventLoop.jpg" alt=""></p>
<h3 id="Libuv的Event-Loop"><a href="#Libuv的Event-Loop" class="headerlink" title="Libuv的Event Loop"></a>Libuv的Event Loop</h3><p>Libuv的Event Loop和chrome的类似，分为<em><code>phase</code></em>和<em><code>tick</code></em>，phase又有细分的种类，tick跟MicroTask类似，用于执行需要在当前运行时执行完毕后马上执行的事件回调，例如<code>promise</code>, <code>process.nextTick</code></p>
<p><img src="/images/eventloop/node-event-loop.png" alt=""></p>
<p><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="external">nodejs官方示例</a>：<br>   ┌───────────────────────┐<br>┌─&gt;│        timers         │<br>│  └──────────┬────────────┘<br>│  ┌──────────┴────────────┐<br>│  │     I/O callbacks     │<br>│  └──────────┬────────────┘<br>│  ┌──────────┴────────────┐<br>│  │     idle, prepare     │<br>│  └──────────┬────────────┘      ┌───────────────┐<br>│  ┌──────────┴────────────┐      │   incoming:   │<br>│  │         poll          │&lt;─────┤  connections, │<br>│  └──────────┬────────────┘      │   data, etc.  │<br>│  ┌──────────┴────────────┐      └───────────────┘<br>│  │        check          │<br>│  └──────────┬────────────┘<br>│  ┌──────────┴────────────┐<br>└──┤    close callbacks    │<br>   └───────────────────────┘</p>
<p>libuv会循环的执行执行每个phase的相应队列，FIFO原则。</p>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><h4 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h4><p>所有通过setTimeout，setInterval调度的事件回调都在这里得到处理</p>
<h3 id="IO-callback"><a href="#IO-callback" class="headerlink" title="IO callback"></a>IO callback</h3><p>绝大部分回调处理的时机，包括http请求引发的回调，文件读写IO回调</p>
<h3 id="IO-Polling"><a href="#IO-Polling" class="headerlink" title="IO Polling"></a>IO Polling</h3><p>给下一轮循环收集新的事件</p>
<h3 id="Immediate"><a href="#Immediate" class="headerlink" title="Immediate"></a>Immediate</h3><p>通过setImmediate调度的事件回调处理</p>
<h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p>处理所有的.on(‘close’)事件回调</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>综上所述：</p>
<ol>
<li>不同的宿主环境实现Event Loop不同</li>
<li>promise在不同浏览器不同版本执行顺序都有可能不一样，依赖实现</li>
<li>js是一个单线程语言，依赖异步模型达到并发效果</li>
<li>代码层面不要让<code>Promise.resolve</code>和<code>setTimeout(fn, 0)</code>竞争执行速度</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>ECMAScript 的 Job Queues 和 Event loop 有什么关系？ - flyingsoul的回答 - 知乎<br><a href="https://www.zhihu.com/question/40063533/answer/271176956" target="_blank" rel="external">https://www.zhihu.com/question/40063533/answer/271176956</a></p>
<p><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-jobs-and-job-queues" target="_blank" rel="external">Ecma Jobs and Jobs Queues</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop" target="_blank" rel="external">Mdn Event Loop</a></p>
<p><a href="https://medium.com/the-node-js-collection/what-you-should-know-to-really-understand-the-node-js-event-loop-and-its-metrics-c4907b19da4c" target="_blank" rel="external">What you should know to really understand the Node.js Event Loop</a></p>
<p><a href="https://medium.com/@gaurav.pandvia/understanding-javascript-function-executions-tasks-event-loop-call-stack-more-part-1-5683dea1f5ec" target="_blank" rel="external">https://medium.com/@gaurav.pandvia/understanding-javascript-function-executions-tasks-event-loop-call-stack-more-part-1-5683dea1f5ec</a></p>
<p><a href="https://stackoverflow.com/questions/10680601/nodejs-event-loop" target="_blank" rel="external">https://stackoverflow.com/questions/10680601/nodejs-event-loop</a></p>
<p><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="external">https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/</a></p>
<p><a href="http://nikhilm.github.io/uvbook/introduction.html#background" target="_blank" rel="external">http://nikhilm.github.io/uvbook/introduction.html#background</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/12/from-promise-polyfill-to-eventloop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="iveswen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Genuifx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/12/from-promise-polyfill-to-eventloop/" itemprop="url">从Promise到Event Loop（一）</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-12T15:31:12+08:00">2018-04-12</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/12/from-promise-polyfill-to-eventloop/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/04/12/from-promise-polyfill-to-eventloop/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一切的开始"><a href="#一切的开始" class="headerlink" title="一切的开始"></a>一切的开始</h1><p>去年某天，t0在群里扔了一道类似下面的题目（不是这道，这道来自<a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" title="jake" target="_blank" rel="external">jake</a>）：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">console</span>.log(<span class="string">'script start'</span>);</div><div class="line"></div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'setTimeout'</span>);</div><div class="line">&#125;, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</div><div class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'promise2'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'script end'</span>);</div></pre></td></tr></table></figure></p>
<p>当时大家都说出一个理所应当的答案<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">script start</div><div class="line">script end</div><div class="line">promise1</div><div class="line">promise2</div><div class="line">setTimeout</div></pre></td></tr></table></figure></p>
<p>然而，有细心的同学把用例放到ie8下面跑的时候就会发现结果有些细小的差异：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">script start</div><div class="line">script end</div><div class="line">setTimeout</div><div class="line">promise1</div><div class="line">promise2</div></pre></td></tr></table></figure></p>
<p>这里冒出了2个问题：</p>
<ol>
<li>ie8并不支持promise</li>
<li>ie8promise的callback执行比setTimeout慢</li>
</ol>
<p>第一个问题很快被解决，因为打开的页面使用mn（[工程化，开发构建利器]）打包，项目自带了promise补丁 😀<br>第二个问题很令人困惑，当时对event loop和microTask的概念还比较模糊，并不能直接找出问题，于是开始怀疑是<a href="https://github.com/zloirock/core-js" target="_blank" rel="external">core-js</a>(mn打的promise-polyfill)的promise实现有问题，和原生的表现不一致，从而开始拜读corejs的实现代码（俄罗斯大哥真的牛逼，一个人维护整个core-js）</p>
<h1 id="Promise-Polyfill"><a href="#Promise-Polyfill" class="headerlink" title="Promise Polyfill"></a>Promise Polyfill</h1><blockquote>
<p>promise的polyfill有多个实现包，包括著名的bluebird, 但是这里只讨论core-js的实现</p>
</blockquote>
<p>照例先上一段代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// core-js/modules/_microtask.js</span></div><div class="line"></div><div class="line">  <span class="comment">// Node.js</span></div><div class="line">  <span class="keyword">if</span> (isNode) &#123;</div><div class="line">    notify = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      process.nextTick(flush);</div><div class="line">    &#125;;</div><div class="line">  <span class="comment">// browsers with MutationObserver</span></div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Observer) &#123;</div><div class="line">    <span class="keyword">var</span> toggle = <span class="literal">true</span>;</div><div class="line">    <span class="keyword">var</span> node = <span class="built_in">document</span>.createTextNode(<span class="string">''</span>);</div><div class="line">    <span class="keyword">new</span> Observer(flush).observe(node, &#123; <span class="attr">characterData</span>: <span class="literal">true</span> &#125;); <span class="comment">// eslint-disable-line no-new</span></div><div class="line">    notify = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      node.data = toggle = !toggle;</div><div class="line">    &#125;;</div><div class="line">  <span class="comment">// environments with maybe non-completely correct, but existent Promise</span></div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Promise</span> &amp;&amp; <span class="built_in">Promise</span>.resolve) &#123;</div><div class="line">    <span class="keyword">var</span> promise = <span class="built_in">Promise</span>.resolve();</div><div class="line">    notify = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      promise.then(flush);</div><div class="line">    &#125;;</div><div class="line">  <span class="comment">// for other environments - macrotask based on:</span></div><div class="line">  <span class="comment">// - setImmediate</span></div><div class="line">  <span class="comment">// - MessageChannel</span></div><div class="line">  <span class="comment">// - window.postMessag</span></div><div class="line">  <span class="comment">// - onreadystatechange</span></div><div class="line">  <span class="comment">// - setTimeout</span></div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    notify = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="comment">// strange IE + webpack dev server bug - use .call(global)</span></div><div class="line">      macrotask.call(global, flush);</div><div class="line">    &#125;;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>代码很简单，通过环境，浏览器的版本等因素找到一个最适合的promise的实现，具体思路如下：</p>
<h3 id="1-node4-直接使用process-nextTick"><a href="#1-node4-直接使用process-nextTick" class="headerlink" title="1. node4+ 直接使用process.nextTick"></a>1. node4+ 直接使用process.nextTick</h3><p>nextTick是node的私有方法，允许在当前调用栈结束立刻执行回调。</p>
<h3 id="2-在支持MutationObserver的浏览器使用Observer"><a href="#2-在支持MutationObserver的浏览器使用Observer" class="headerlink" title="2. 在支持MutationObserver的浏览器使用Observer"></a>2. 在支持MutationObserver的浏览器使用Observer</h3><p>MutationObserver用于监听DOM节点，当节点发生变化的时候，执行回调函数。(MutationObserver同样在vue源码中用上了~)当前MutationObserver的proposal已经被废弃。<br><img src="/images/eventloop/WX20180327-210644.png" alt="MutationObserver"></p>
<h3 id="3-当前环境已经有打promise的补丁的话，直接使用promise补丁"><a href="#3-当前环境已经有打promise的补丁的话，直接使用promise补丁" class="headerlink" title="3. 当前环境已经有打promise的补丁的话，直接使用promise补丁"></a>3. 当前环境已经有打promise的补丁的话，直接使用promise补丁</h3><p>因为如果不支持1，2两种方式的话，说明完全标准的promise补丁已经没法实现了，这个时候只能委屈求全了。</p>
<h3 id="4-当以上情况都不适用，使用下面的几种backup"><a href="#4-当以上情况都不适用，使用下面的几种backup" class="headerlink" title="4. 当以上情况都不适用，使用下面的几种backup"></a>4. 当以上情况都不适用，使用下面的几种backup</h3><ul>
<li>node0.8-的process.nextTick(<a href="https://github.com/nodejs/node/wiki/API-changes-between-v0.8-and-v0.10" target="_blank" rel="external">node0.8-的process.nextTick属于macroTask</a>)</li>
<li>Sphere(游戏引擎) 的Dispatch方法</li>
<li>MessageChannel（多线程通信, 双向，支持webworker）</li>
<li>window.postMessage (单向, 支持webworker)</li>
<li>IE8-监听节点的ONREADYSTATECHANGE事件</li>
<li>setTimeout (最后的无奈)</li>
</ul>
<p>补一张图片说明：<br><img src="/images/eventloop/Promise polyfill.png" alt="promise-polyfill"></p>
<p>至此可以清晰的了解到core-js的补丁思路，当1，2行的通的时候我们会得到一个“相对标准”的promise。3，4能让我们得到一个“勉强实现的promise”<br>这里回到我们的问题，当文章的示例脚本跑在IE8的时候，很明显我们逻辑会走到ONREADYSTATECHANGE这儿，那么为什么监听的事件回调为什么比setTimeout慢执行呢？是不是所有的事件回调都比setTimeout慢呢？http请求的呢？到底异步队列是怎么实现的？标准如何？</p>
<p>故事很长，下回再续。</p>
<!-- # 下回
[从Promise到Event Loop（二）](http://km.weoa.com/group/fe/article/3474) -->
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="external">MutationObserver</a><br><a href="https://caniuse.com/#search=MutationObserver" target="_blank" rel="external">Caniuse</a><br><a href="https://github.com/YuzuJS/setImmediate#macrotasks-and-microtasks." target="_blank" rel="external">macroTask and microTask</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/18/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="iveswen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Genuifx">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/18/index/" itemprop="url">index</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-18T17:11:56+08:00">2017-08-18</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/18/index/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/08/18/index/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Hello, world!</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpg"
                alt="iveswen" />
            
              <p class="site-author-name" itemprop="name">iveswen</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/genuifx" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:genuifx@gmail.com" target="_blank" title="E-Mail" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/ZetianWen" target="_blank" title="Twitter" rel="external nofollow"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">iveswen</span>

  

  
</div>


  



  <div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  

  
    <script id="dsq-count-scr" src="https://genuifx.disqus.com/count.js" async></script>
  

  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
